#!/bin/bash

# Unity Vibe CLI - Scene Creation Script
# Creates a new Unity scene using command line interface
# Usage: unity-create-scene <scene_name> <scene_path> [scene_type] [add_to_build]

# Check if Unity executable exists
UNITY_PATH=""
if command -v /mnt/c/Program\ Files/Unity/Hub/Editor/*/Editor/Unity.exe >/dev/null 2>&1; then
    UNITY_PATH=$(find /mnt/c/Program\ Files/Unity/Hub/Editor/*/Editor/Unity.exe | head -1)
elif command -v unity >/dev/null 2>&1; then
    UNITY_PATH="unity"
else
    echo "Error: Unity Editor not found. Please ensure Unity is installed and accessible."
    exit 1
fi

# Check arguments
if [ $# -lt 2 ]; then
    echo "Usage: unity-create-scene <scene_name> <scene_path> [scene_type] [add_to_build]"
    echo ""
    echo "Arguments:"
    echo "  scene_name    - Name of the scene to create"
    echo "  scene_path    - Directory path where scene will be created"
    echo "  scene_type    - (Optional) Scene setup type (Empty, DefaultGameObjects, 2D, 3D, etc.)"
    echo "  add_to_build  - (Optional) Whether to add scene to build settings (true/false)"
    echo ""
    echo "Examples:"
    echo "  unity-create-scene MyScene Assets/Scenes"
    echo "  unity-create-scene GameScene Assets/Scenes/Game DefaultGameObjects true"
    echo "  unity-create-scene UIScene Assets/Scenes/UI 2D false"
    exit 1
fi

SCENE_NAME="$1"
SCENE_PATH="$2"
SCENE_TYPE="${3:-DefaultGameObjects}"
ADD_TO_BUILD="${4:-false}"

# Get current directory (assuming it's the Unity project root)
# Convert WSL path to Windows path for Unity
if [[ $(pwd) == /mnt/c/* ]]; then
    PROJECT_PATH=$(pwd | sed 's|/mnt/c|C:|')
else
    PROJECT_PATH=$(pwd)
fi

echo "Unity Vibe CLI - Creating Scene"
echo "================================"
echo "Scene Name: $SCENE_NAME"
echo "Scene Path: $SCENE_PATH"
echo "Scene Type: $SCENE_TYPE"
echo "Add to Build: $ADD_TO_BUILD"
echo "Project Path: $PROJECT_PATH"
echo ""

# Execute Unity command
"$UNITY_PATH" \
    -batchmode \
    -quit \
    -projectPath "$PROJECT_PATH" \
    -executeMethod UnityVibe.Editor.CLI.CreateSceneFromCommandLine \
    "$SCENE_NAME" \
    "$SCENE_PATH" \
    "$SCENE_TYPE" \
    "$ADD_TO_BUILD"

# Check exit code
if [ $? -eq 0 ]; then
    echo ""
    echo "✅ Scene created successfully: $SCENE_PATH/$SCENE_NAME.unity"
else
    echo ""
    echo "❌ Failed to create scene. Check Unity console for details."
    exit 1
fi